[gd_scene load_steps=4 format=3 uid="uid://ivo77piqgdfv"]

[ext_resource type="PackedScene" uid="uid://bi6uykfg167sj" path="res://source/player/car.tscn" id="1_ldj6h"]
[ext_resource type="Texture2D" uid="uid://dehg38xt8tidn" path="res://resource/image/car.png" id="2_mhcvl"]

[sub_resource type="GDScript" id="GDScript_tuphj"]
script/source = "
extends Car

@onready var camera = $Camera

var enemy_close = []
# Attacks
@onready var gun = $Attack/Gun
@onready var bullet = preload('res://source/attack/bullet.tscn')
@onready var bullet_timer = $Attack/BulletTimer
@onready var bullet_attack_timer = $Attack/BulletTimer/BulletAttackTimer
var bullet_level = 1
var bullet_attack_speed = 0.1 # 0.1

func _ready():
	camera.set_as_top_level(true)
	# gun.rotation = 44
	attack()

func physics_process(delta):
	camera.global_position = global_position
	camera.rotation = lerp_angle(camera.rotation, rotation + deg_to_rad(90), 0.1)
	
	gun.look_at(get_global_mouse_position())

# 自定义函数 =============================================================

func control():
	if Input.is_action_pressed('ui_left'):
		current_steering_angle = lerp_angle(current_steering_angle, deg_to_rad(-max_steering_angle), steering_speed)
	elif Input.is_action_pressed('ui_right'):
		current_steering_angle = lerp_angle(current_steering_angle, deg_to_rad(max_steering_angle), steering_speed)
	else:
		current_steering_angle = lerp_angle(current_steering_angle, 0, 0.1)
	
	var target_acc = Vector2()
	if Input.is_action_pressed('ui_up'):
		current_acc = lerpf(current_acc, max_acc, 0.05) # 切换档位
		target_acc = transform.x * current_acc
	elif Input.is_action_pressed('ui_down'):
		target_acc = transform.x * reverse_acc
		current_acc = 0 # 如果我在刹车，发动机会关闭
	else:
		current_acc = lerpf(current_acc, 0, 0.001) # 如果我释放了加速键，发动机会减速但不会立即停止
	acc = target_acc

func attack():
	if bullet_level == 0:
		gun.hide()
	if bullet_level > 0:
		gun.show()
		bullet_timer.wait_time = bullet_attack_speed
		if bullet_timer.is_stopped():
			bullet_timer.start()

# 信号 ================================================================
	
# 子弹信号
func _on_bullet_timer_timeout():
	if len(enemy_close) > 1:
		var bullet_attack = bullet.instantiate()
		bullet_attack.target = get_local_mouse_position()# get_random_target()
		# gun.look_at(bullet_attack.target)
		bullet_attack.level = bullet_level
		# 获取父级的全局旋转
		#var parent_global_rotation = rotation#+44
		# 将子弹的方向与父级的旋转保持一致
		# bullet_attack.rotation = $Attack/Gun.rotation
		
		# bullet_attack.look_at(bullet_attack.target)
		add_child(bullet_attack)
			
func get_random_target():
	if enemy_close.size() > 0:
		return enemy_close.pick_random().global_position
	else:
		return Vector2.UP

# 敌人检测区域信号
func _on_enemy_detection_area_body_entered(body):
	if not enemy_close.has(body):
		enemy_close.append(body)

func _on_enemy_detection_area_body_exited(body):
	if enemy_close.has(body):
		enemy_close.erase(body)

func _on_grab_area_area_entered(area):
	if area.is_in_group('loot'):
		area.target = self


"

[node name="CarPlayer" groups=["player"] instance=ExtResource("1_ldj6h")]
collision_layer = 7
collision_mask = 7
script = SubResource("GDScript_tuphj")

[node name="Camera" type="Camera2D" parent="." index="0"]
scale = Vector2(0.5, 0.5)
ignore_rotation = false
position_smoothing_speed = 3.0
rotation_smoothing_speed = 3.0

[node name="Sprite" parent="." index="2"]
scale = Vector2(6, 6)
texture = ExtResource("2_mhcvl")

[node name="TrailPos1" parent="." index="3"]
position = Vector2(-33, -12)

[node name="TrailPos2" parent="." index="4"]
position = Vector2(30, -12)

[node name="TrailPos3" parent="." index="5"]
position = Vector2(-33, 12)

[node name="TrailPos4" parent="." index="6"]
position = Vector2(30, 12)
